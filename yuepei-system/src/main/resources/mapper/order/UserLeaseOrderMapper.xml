<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yuepei.system.mapper.UserLeaseOrderMapper">

    <resultMap type="UserLeaseOrder" id="UserLeaseOrderResult">
        <result property="id"    column="id"    />
        <result property="openid"    column="openid"    />
        <result property="orderNumber"    column="order_number"    />
        <result property="deviceNumber"    column="device_number"    />
        <result property="deviceType"    column="device_type"    />
        <result property="leaseTime"    column="lease_time"    />
        <result property="leaseAddress"    column="lease_address"    />
        <result property="restoreTime"    column="restore_time"    />
        <result property="restoreAddress"    column="restore_address"    />
        <result property="price"    column="price"    />
        <result property="payType"    column="pay_type"    />
        <result property="netAmount"    column="net_amount"    />
        <result property="couponPrice"    column="coupon_price"    />
        <result property="status"    column="status"    />
        <result property="deposit"    column="deposit"    />
        <result property="playTime"    column="play_time"    />
        <result property="createTime" column="create_time"/>
    </resultMap>

    <resultMap id="LeaseOrderResult" type="LeaseOrderVO">
        <result property="id" column="id"/>
        <result property="orderNumber" column="order_number"/>
        <result property="createTime" column="create_time"/>
        <result property="deviceNumber" column="device_number"/>
        <result property="price" column="price"/>
        <result property="status" column="status"/>
        <result property="couponPrice" column="coupon_price"/>
        <result property="deviceType" column="device_type"/>
        <result property="deviceTypeId" column="device_type_id"/>
        <result property="hospitalName" column="hospital_name"/>
        <result property="leaseAddress" column="lease_address"/>
        <result property="netAmount" column="net_amount"/>
        <result property="leaseTime" column="lease_time"/>
        <result property="nickName" column="nick_name"/>
        <result property="payType" column="pay_type"/>
        <result property="playTime" column="play_time"/>
        <result property="restoreAddress" column="restore_address"/>
        <result property="restoreTime" column="restore_time"/>
    </resultMap>

    <sql id="selectUserLeaseOrderVo">
        select id, openid, order_number, device_number, device_type, lease_time, lease_address, restore_time, restore_address, price, pay_type, net_amount, deposit, coupon_price, status, play_time,create_time from user_lease_order
    </sql>

    <sql id="selectLeaseOrderVO">
        SELECT lo.id,u.`nick_name`,d.`device_type_id`, lo.order_number,
        lo.device_number, lo.device_type, lo.lease_time,
        lo.lease_address, h.`hospital_name`,
        lo.restore_time, lo.restore_address, lo.price, lo.pay_type,
        lo.net_amount, lo.coupon_price, lo.`status`,
        lo.play_time,lo.create_time FROM user_lease_order AS lo
        INNER JOIN sys_user AS u ON lo.`openid` = u.`openid`
        INNER JOIN device AS d ON d.`device_number` = lo.`device_number`
        INNER JOIN hospital AS h ON d.`hospital_id` = h.`hospital_id`
    </sql>

    <select id="leaseOrderList" parameterType="LeaseOrderVO" resultMap="LeaseOrderResult">
        <include refid="selectLeaseOrderVO"/>
<!--        <where>-->
<!--            <if test="openid != null  and openid != ''"> and openid = #{openid}</if>-->
<!--            <if test="orderNumber != null  and orderNumber != ''"> and order_number = #{orderNumber}</if>-->
<!--            <if test="deviceNumber != null  and deviceNumber != ''"> and device_number = #{deviceNumber}</if>-->
<!--            <if test="deviceType != null  and deviceType != ''"> and device_type = #{deviceType}</if>-->
<!--            <if test="leaseTime != null "> and lease_time = #{leaseTime}</if>-->
<!--            <if test="leaseAddress != null  and leaseAddress != ''"> and lease_address = #{leaseAddress}</if>-->
<!--            <if test="restoreTime != null "> and restore_time = #{restoreTime}</if>-->
<!--            <if test="restoreAddress != null  and restoreAddress != ''"> and restore_address = #{restoreAddress}</if>-->
<!--            <if test="price != null "> and price = #{price}</if>-->
<!--            <if test="payType != null  and payType != ''"> and pay_type = #{payType}</if>-->
<!--            <if test="netAmount != null  and netAmount != ''"> and net_amount = #{netAmount}</if>-->
<!--            <if test="couponPrice != null "> and coupon_price = #{couponPrice}</if>-->
<!--            <if test="status != null  and status != ''"> and status = #{status}</if>-->
<!--            <if test="playTime != null  and playTime != ''"> and play_time = #{playTime}</if>-->
<!--        </where>-->
    </select>

    <select id="selectUserLeaseOrderList" parameterType="UserLeaseOrder" resultMap="UserLeaseOrderResult">
        <include refid="selectUserLeaseOrderVo"/>
        <where>
            <if test="openid != null  and openid != ''"> and openid = #{openid}</if>
            <if test="orderNumber != null  and orderNumber != ''"> and order_number = #{orderNumber}</if>
            <if test="deviceNumber != null  and deviceNumber != ''"> and device_number = #{deviceNumber}</if>
            <if test="deviceType != null  and deviceType != ''"> and device_type = #{deviceType}</if>
            <if test="leaseTime != null "> and lease_time = #{leaseTime}</if>
            <if test="leaseAddress != null  and leaseAddress != ''"> and lease_address = #{leaseAddress}</if>
            <if test="restoreTime != null "> and restore_time = #{restoreTime}</if>
            <if test="restoreAddress != null  and restoreAddress != ''"> and restore_address = #{restoreAddress}</if>
            <if test="price != null "> and price = #{price}</if>
            <if test="payType != null  and payType != ''"> and pay_type = #{payType}</if>
            <if test="netAmount != null  and netAmount != ''"> and net_amount = #{netAmount}</if>
            <if test="couponPrice != null "> and coupon_price = #{couponPrice}</if>
            <if test="status != null  and status != ''"> and status = #{status}</if>
            <if test="playTime != null  and playTime != ''"> and play_time = #{playTime}</if>
        </where>
    </select>

    <select id="selectUserLeaseOrderById" parameterType="Long" resultMap="UserLeaseOrderResult">
        <include refid="selectUserLeaseOrderVo"/>
        where id = #{id}
    </select>
    <select id="userLeaseOrder" resultMap="UserLeaseOrderResult">
        select a.*,b.rule from user_lease_order a,device_rule b
        <where>
            a.openid = #{openid}
            and a.device_number=b.device_number
            <if test="status != null">and a.status = #{status}</if>
        </where>
    </select>

    <insert id="insertUserLeaseOrder" parameterType="UserLeaseOrder" useGeneratedKeys="true" keyProperty="id">
        insert into user_lease_order
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="openid != null">openid,</if>
            <if test="orderNumber != null">order_number,</if>
            <if test="deviceNumber != null">device_number,</if>
            <if test="deviceType != null">device_type,</if>
            <if test="leaseTime != null">lease_time,</if>
            <if test="leaseAddress != null">lease_address,</if>
            <if test="restoreTime != null">restore_time,</if>
            <if test="restoreAddress != null">restore_address,</if>
            <if test="price != null">price,</if>
            <if test="payType != null">pay_type,</if>
            <if test="netAmount != null">net_amount,</if>
            <if test="couponPrice != null">coupon_price,</if>
            <if test="status != null">status,</if>
            <if test="playTime != null">play_time,</if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="openid != null">#{openid},</if>
            <if test="orderNumber != null">#{orderNumber},</if>
            <if test="deviceNumber != null">#{deviceNumber},</if>
            <if test="deviceType != null">#{deviceType},</if>
            <if test="leaseTime != null">#{leaseTime},</if>
            <if test="leaseAddress != null">#{leaseAddress},</if>
            <if test="restoreTime != null">#{restoreTime},</if>
            <if test="restoreAddress != null">#{restoreAddress},</if>
            <if test="price != null">#{price},</if>
            <if test="payType != null">#{payType},</if>
            <if test="netAmount != null">#{netAmount},</if>
            <if test="couponPrice != null">#{couponPrice},</if>
            <if test="status != null">#{status},</if>
            <if test="playTime != null">#{playTime},</if>
        </trim>
    </insert>

    <update id="updateUserLeaseOrder" parameterType="UserLeaseOrder">
        update user_lease_order
        <trim prefix="SET" suffixOverrides=",">
            <if test="openid != null">openid = #{openid},</if>
            <if test="orderNumber != null">order_number = #{orderNumber},</if>
            <if test="deviceNumber != null">device_number = #{deviceNumber},</if>
            <if test="leaseTime != null">lease_time = #{leaseTime},</if>
            <if test="leaseAddress != null">lease_address = #{leaseAddress},</if>
            <if test="restoreTime != null">restore_time = #{restoreTime},</if>
            <if test="restoreAddress != null">restore_address = #{restoreAddress},</if>
            <if test="price != null">price = #{price},</if>
            <if test="payType != null">pay_type = #{payType},</if>
            <if test="netAmount != null">net_amount = #{netAmount},</if>
            <if test="couponPrice != null">coupon_price = #{couponPrice},</if>
            <if test="status != null">status = #{status},</if>
            <if test="playTime != null">play_time = #{playTime},</if>
        </trim>
        where id = #{id}
    </update>

    <update id="updateUserLeaseOrderByOrderNumber">
        update user_lease_order
        <trim prefix="SET" suffixOverrides=",">
            <if test="openid != null">openid = #{openid},</if>
            <if test="orderNumber != null">order_number = #{orderNumber},</if>
            <if test="deviceNumber != null">device_number = #{deviceNumber},</if>
            <if test="restoreTime != null">restore_time = #{restoreTime},</if>
            <if test="restoreAddress != null">restore_address = #{restoreAddress},</if>
            <if test="price != null">price = #{price},</if>
            <if test="payType != null">pay_type = #{payType},</if>
            <if test="netAmount != null">net_amount = #{netAmount},</if>
            <if test="couponPrice != null">coupon_price = #{couponPrice},</if>
            <if test="status != null">status = #{status},</if>
            <if test="playTime != null">play_time = #{playTime},</if>
        </trim>
        where order_number = #{orderNumber}
    </update>

    <delete id="deleteUserLeaseOrderById" parameterType="Long">
        delete from user_lease_order where id = #{id}
    </delete>

    <delete id="deleteUserLeaseOrderByIds" parameterType="String">
        delete from user_lease_order where id in
        <foreach item="id" collection="array" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

    <select id="selectUserLeaseOrder" parameterType="UserLeaseOrder" resultMap="UserLeaseOrderResult">
        <include refid="selectUserLeaseOrderVo"/>
        where device_number in
        <foreach item="device_number" collection="list" index="index" open="(" separator="," close=")">
            #{device_number}
        </foreach>
    </select>
    <select id="selectLeaseOrderDetails" parameterType="UserLeaseOrder" resultMap="UserLeaseOrderResult">
        <include refid="selectUserLeaseOrderVo"/>
        where order_number=#{orderNumber}
    </select>

    <select id="selectRevenueStatistics" parameterType="UserLeaseOrder" resultMap="UserLeaseOrderResult">
        <include refid="selectUserLeaseOrderVo"/>
        where status=2
        and device_number in
        <foreach item="device_number" collection="list" index="index" open="(" separator="," close=")">
            #{device_number}
        </foreach>
    </select>

    <select id="selectDayOrder" resultType="com.yuepei.system.domain.vo.OrderSumAndMoneyVO">
        SELECT (SELECT COUNT(1) FROM user_lease_order WHERE DATE_SUB(CURDATE(), INTERVAL 0 DAY) &lt;= lease_time AND `status` = 2) AS `todayOrderNum`,
               (SELECT IFNULL(SUM(net_amount),0) FROM user_lease_order WHERE DATE_SUB(CURDATE(), INTERVAL 0 DAY) &lt;= create_time AND `status` = 2) AS todayOrderMoney,
               (SELECT COUNT(1) FROM user_lease_order WHERE DATE_SUB(CURDATE(), INTERVAL 7 DAY) &lt;= lease_time AND `status` = 2) AS `sevenDayOrderNum`,
               (SELECT IFNULL(SUM(net_amount),0) FROM user_lease_order WHERE DATE_SUB(CURDATE(), INTERVAL 7 DAY) &lt;= create_time AND `status` = 2) AS sevenDayOrderMoney,
               (SELECT COUNT(1) FROM user_lease_order WHERE DATE_SUB(CURDATE(), INTERVAL 29 DAY) &lt;= lease_time AND `status` = 2) AS thirtyDayOrderNum,
               (SELECT IFNULL(SUM(net_amount),0) FROM user_lease_order WHERE DATE_SUB(CURDATE(), INTERVAL 29 DAY) &lt;= create_time AND `status` = 2) AS thirtyDayOrderMoney
    </select>
    <select id="selectConditionOrder" resultType="com.yuepei.system.domain.vo.ConditionOrderVO">
        SELECT (SELECT IFNULL(SUM(net_amount),0) FROM user_lease_order) AS conditionOrderMoney,
        (SELECT COUNT(1) FROM user_lease_order) AS conditionOrderNum
        <where>
            <if test="deviceNumber != null  and deviceNumber != ''"> and device_number = #{deviceNumber}</if>
            <if test="payType != null  and payType != ''"> and pay_type = #{payType}</if>
            <if test="status != null  and status != ''"> and status = #{status}</if>
            <if test="outTradeNo != null and outTradeNo != ''">out_trade_no = #{outTradeNo},</if>
        </where>
    </select>
    <select id="selectUserLeaseOrderByDeviceNumber" parameterType="UserLeaseOrder" resultMap="UserLeaseOrderResult">
        <include refid="selectUserLeaseOrderVo"/>
        where status=2
        and device_number=#{deviceNumber}
    </select>
    <select id="selectUseDevice" resultType="UserLeaseOrder" resultMap="UserLeaseOrderResult">
        select distinct device_number from user_lease_order where device_number=#{deviceNumber} and status=0
    </select>
</mapper>
